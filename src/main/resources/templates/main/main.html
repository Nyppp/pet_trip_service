<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>떠나개 - 반려동물 동반 여행 플랫폼</title>
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
  </head>
  <body>
    <!-- 공통 헤더 포함 -->
    <div th:replace="~{common/header :: siteHeader}"></div>

    <!-- 검색 -->
    <section class="search-bar">
      <div class="container">
        <div class="search-header">
          <h1 class="search-title">반려동물과 함께하는 특별한 여행</h1>
          <p class="search-subtitle">떠나개에서 당신의 완벽한 펫프렌들리 여행지를 찾아보세요</p>
        </div>
        <form id="search-form" th:action="@{/search}" method="get" role="search">
          <input type="hidden" name="page" value="0" />
          <input type="hidden" name="size" value="12" />
          <input type="hidden" id="sort" name="sort" value="relevance" />

          <div class="search-inputs">
            <label for="cat1" class="sr-only">카테고리</label>
            <select id="cat1" name="cat1">
              <option value="">전체 카테고리</option>
              <option th:each="cat : ${category.entrySet()}" th:value="${cat.key}" th:text="${cat.value}"></option>
            </select>

            <label for="keyword" class="sr-only">검색어</label>
            <input id="keyword" name="keyword" type="text" placeholder="어디로 떠나고 싶으신가요?" />
          </div>

          <div class="search-buttons">
            <button type="submit">검색하기</button>
            <a class="map-btn" th:href="@{/location/permission}">지도로 검색</a>
          </div>
        </form>
      </div>
    </section>

    <!-- 본문: 인기 장소 등 -->
    <div class="main-content">
      <div class="container">
        <h2 class="section-title">지금 인기있는 장소</h2>
        <div th:if="${places != null and !places.isEmpty()}" class="likes-section">
          <div class="places-carousel">
            <button class="carousel-btn prev" type="button" aria-label="이전">‹</button>

            <div class="carousel-track" id="placesTrack">
              <div th:each="place : ${places}" class="place-card">
                <div class="place-image">
                  <div class="place-image-wrap">
                    <img
                      th:if="${place.imageUrls != null and !place.imageUrls.isEmpty()}"
                      th:src="${place.imageUrls[0]}"
                      th:alt="${place.name} + ' 이미지'"
                      onerror="this.onerror=null; this.src='/images/project_logo.png';"
                    />

                    <img
                      th:unless="${place.imageUrls != null and !place.imageUrls.isEmpty()}"
                      th:src="@{/images/project_logo.png}"
                      th:alt="${place.name} + ' 이미지'"
                    />
                  </div>
                </div>

                <div class="place-info">
                  <h3 class="place-name" th:text="${place.name}">장소 이름</h3>
                  <p class="place-category" th:text="${place.categoryName}">카테고리</p>
                  <p class="place-address" th:text="${place.address}">주소</p>
                  <div class="place-meta">
                    <div class="rating">
                      <div class="stars" th:style="|--percent: ${(place.rating != null ? place.rating : 0) * 20}%|"></div>
                      <span class="rating-text" th:text="${place.rating != null ? #numbers.formatDecimal(place.rating, 1, 1) : '0.0'}">0.0</span>
                    </div>
                    <div class="like-count">
                      <img src="/images/heart_filled.svg" alt="찜" width="16" height="16" />
                      <span th:text="${place.liked}">0</span>
                    </div>
                  </div>
                </div>

                <div class="place-actions">
                  <a th:href="|/place/${place.id}|" class="view-detail-btn">상세보기</a>
                </div>
              </div>
            </div>

            <button class="carousel-btn next" type="button" aria-label="다음">›</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 채팅 버튼 -->
    <div id="chat-toggle-btn">
      <button>
        <img class="chat-btn-logo" src="/images/chatbot_logo.png" alt="채팅하기" />
      </button>
    </div>

    <!-- 채팅 모달 -->
    <div id="chat-modal" class="sr-only">
      <div id="chat-modal-header">
        <img class="chat-btn-logo" src="/images/chatbot_logo.png" alt="채팅하기" />
        <div>
          <div class="chat-modal-header-title">떠나개</div>
        </div>
        <button id="clear-chat-btn" class="header-btn">🗑 초기화</button>
      </div>
      <div id="chat-modal-body">
        <div class="chat-message bot-message">무엇을 도와드릴까요?</div>
      </div>
      <div id="chat-modal-input">
        <input id="chat-input" type="text" placeholder="메세지를 입력하세요." />
        <button>보내기</button>
      </div>
    </div>

    <!-- 푸터 -->
    <footer>
      <div class="container">&copy; 2025 떠나개. 반려동물과 함께하는 행복한 여행을 응원합니다.</div>
    </footer>

    <!-- 스크립트 최적화 로딩 -->
    <script src="/scripts/mainFront.js" defer></script>
    <script src="/scripts/main.js" defer></script>
    <script>
      // 즉시 실행되는 필수 스크립트만 여기에 배치
      document.addEventListener("DOMContentLoaded", function () {
        // 검색 폼 이벤트 리스너
        document.getElementById("keyword")?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") document.getElementById("search-form").submit();
        });
      });
    </script>
  </body>
</html>
